<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">
        <title>Pay Android</title>
        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="./css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">Pay Android</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="index.html">开发文档</a>
                    </li>
                    <li >
                        <a href="module/example/README/index.html">示例和功能</a>
                    </li>
                    <li >
                        <a href="module/class_doc/README/index.html">类库文档</a>
                    </li>
                    <li >
                        <a href="module/update_log/README/index.html">更新日志</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li class="disabled">
                        <a rel="next" >
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="module/example/README/index.html">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#_1">简介</a></li>
        <li class="main "><a href="#_2">使用需知</a></li>
        <li class="main "><a href="#_3">打款需知</a></li>
        <li class="main "><a href="#_4">支持平台</a></li>
        <li class="main "><a href="#_5">启用须知</a></li>
        <li class="main "><a href="#_6">支付接口快速入门</a></li>
        <li class="main "><a href="#_7">类库说明</a></li>
        <li class="main "><a href="#_8">支付服务</a></li>
        <li class="main "><a href="#_9">查询订单</a></li>
        <li class="main "><a href="#_10">支付回调</a></li>
        <li class="main "><a href="#v31120170111">新版支付v3.1.1(20170111)的更新提示</a></li>
        <li class="main "><a href="#_11">其他</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="_1">简介</h2>
<p>Android支付SDK接口是Bmob为广大开发人员提供的统一、正规的收费手段，让没有企业认证的个人开发者，也能通过支付宝和微信向用户收费。该文档可以让您快速为自己的应用接入Bmob的支付功能。下图为使用支付的流程。</p>
<p><img alt="" src="http://i.imgur.com/pP4Cki6.png" /></p>
<h2 id="_2">使用需知</h2>
<p>
使用Bmob支付组件前，请认真阅读<a href="http://www.bmob.cn/service">Bmob服务协议</a>。</p>
<p>对于以下两种情况，开发者需要特别注意：</p>
<p>1.违反服务协议，特别是含有以下内容的应用：</p>
<p><strong>1）封建迷信和/或淫秽、色情、下流的信息或教唆犯罪的信息；</strong>
<strong>2）博彩有奖、赌博游戏、“私服”、“外挂”等非法互联网出版活动；</strong></p>
<p>Bmob平台有权进行独立判断并采取技术手段予以删除、屏蔽或断开链接。同时，本平台有权视用户的行为性质，采取包括但不限于暂停或终止服务，限制、冻结或终止本平台网站账号的使用，追究法律责任等措施。</p>
<p>2.应用遇到过多的用户投诉，如应用的使用者支付了相关款项，但是该应用却没有提供相应的服务。本平台有权限制或冻结该应用支付收入的所有款项，并保留追究法律责任的权利。</p>
<p>3.<strong>Bmob将在每笔交易中收取8%服务费。</strong></p>
<h2 id="_3">打款需知</h2>
<p>1.打款前请先在控制台填写以下信息</p>
<p><img alt="" src="./image/14579272227324.jpg" /></p>
<p>2.每月的1、2、16、17号为申请打款时间，15号、月尾日为打款时间，确保用户有半个月的追诉期。</p>
<h2 id="_4">支持平台</h2>
<p>目前安卓的支付支持支付宝和微信支付。</p>
<h2 id="_5">启用须知</h2>
<ul>
<li>在Bmob账号管理平台进行身份认证，以保证资金安全，否则无法使用支付等功能。</li>
<li>
<p>提交申请时，开发者的联系方式至少要有两种(邮箱，电话，QQ)，方便后续支付弹出的订单页面展示，如下
<img alt="" src="http://i.imgur.com/TmoXagK.png" /></p>
</li>
<li>
<p>如有任何疑问或者建议，欢迎加入Bmob支付的技术支持QQ群：273080081(1群)，521591577(2群)</p>
</li>
</ul>
<h2 id="_6">支付接口快速入门</h2>
<ul>
<li>
<p>添加相关文件</p>
<p>1 将下载的支付SDK的libs目录添加到项目下，包括<BmobPay_v3.x.x_xxxxxx.jar>和<xxx/libbmobwpay.so>，so文件按项目需求添加(这个版本不需要支付宝jar包)</p>
<p>2 将下载的支付SDK的assets目录添加到项目下，包括<payassets.db>和<bp.db>，其中bp.db其实是apk文件，是微信支付插件</p>
</li>
<li>
<p>在您项目的AndroidManifest.xml中添加以下权限:</p>
<pre><code>&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
</code></pre>
</li>
<li>
<p>修改混淆规则</p>
<pre><code>-libraryjars libs/BmobPay_v3.x.x_xxxxxx.jar
-keepclasseswithmembers class c.b.** { *; }
-keep interface c.b.PListener{ *; }
-keep interface c.b.QListener{ *; }
</code></pre>
</li>
<li>
<p>添加下免责Activity(注意这个是在运行时加载的类,可以忽略IDE给出的红色标识)</p>
<pre><code>&lt;activity android:name="cn.bmob.pay.v3.act.PayAct" /&gt;
</code></pre>
</li>
<li>
<p>在您的应用程序主Application的onCreate中调用如下方法：
  （Application ID在后台应用管理的 数据浏览-&gt;应用信息-&gt;应用密钥-&gt;Application ID，如果appKey为空或者混淆规则不正确，会抛出IllegalArgumentException异常,因为init是异步的，越早初始化越好）</p>
<pre><code>BP.init("你的Application ID");
</code></pre>
<p><strong>注意：新版的支付SDK不能被数据服务SDK的初始化方法取代了，无论您是否使用了Bmob数据服务SDK，都要进行支付SDK的初始化</strong></p>
</li>
<li>
<p>发起支付调用，请使用如下方法：</p>
<p>/*<em>
     * 第4个参数为true时调用支付宝支付，为false时调用微信支付
     </em>/
    BP.pay("商品名称", "商品描述", 0.02, true, new Plistener(){...});</p>
</li>
<li>
<p>在需要调用订单查询的地方，调用如下方法(微信订单和支付宝订单通用)：</p>
<pre><code>BP.query("订单id", new QListener(){...});
</code></pre>
</li>
</ul>
<h2 id="_7">类库说明</h2>
<p><strong>c.b.BP</strong></p>
<ul>
<li>BP.pay(String title, String descript, double money, boolean aliOrWetchat, Plistener listener)</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>title</td>
<td>商品的名称,请注意不要有违禁字眼,可以为空<p>只允许中文、数字、英文和下划线、英文破折号，否则过滤</td>
</tr>
<tr>
<td>String</td>
<td>descript</td>
<td>商品的详情描述,请注意不要有违禁字眼,可以为空<p>只允许中文、数字、英文和下划线、英文破折号，否则过滤</td>
</tr>
<tr>
<td>double</td>
<td>price</td>
<td>商品的价格,建议测试用0.02</td>
</tr>
<tr>
<td>boolean</td>
<td>aliOrWetchat</td>
<td>支付方式：true为支付宝支付，false为微信支付</td>
</tr>
<tr>
<td>Plistener</td>
<td>listener</td>
<td>支付结果监听类c.b.PListener<p>有成功、失败、未知结果、返回订单号等方法</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong></p>
<p><strong>支付时返回的信息都未必可靠，一切以查询订单返回的信息为准</strong></p>
<pre><code>调用微信支付，要安装插件(如果没有安装,会监听器的fail方法会返回-3错误码)，插件在SDK文档的plugin文件夹下，demo有通过assets安装的示例
</code></pre>
<ul>
<li>BP.query(String orderId, QListener listener)</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>orderId</td>
<td>支付订单号,不可为空</td>
</tr>
<tr>
<td>OrderQueryListener</td>
<td>listener</td>
<td>查询结果监听类c.b.QListener<p>有成功、失败等方法</td>
</tr>
</tbody>
</table>
<ul>
<li>！！！ForceFree方法已经弃用(开发者需自己控制用户多次点击支付产生多个订单的问题)</li>
<li>
<p>ForceFree() </p>
<p>当上一次支付操作尚未完成时,如果BmobPay对象发起再次请求,PayListener会回调fail方法返回并10777错误码,以免生成多个订单<p>
如果使用过程中出现了阻塞(比如异常强制关闭支付插件页面,会导致一直不能再发起请求，这是小概率事件),则调用此方法进行BmobPay的重置<p>
仅对下一次请求生效,而不是永久消除限制</p>
</li>
</ul>
<p><strong>c.b.PListener</strong></p>
<ul>
<li>
<p>orderId(String orderId)</p>
<p>无论支付成功与否,只要成功产生了请求,就返回订单号,请自行保存以便以后查询</p>
</li>
<li>
<p>succeed()</p>
<p>支付成功,保险起见请调用查询方法确认结果</p>
</li>
<li>
<p>fail(int code, String reason)</p>
<p>支付失败,有可能是用户中断支付,也有可能是网络问题<p>返回10777时说明上次操作尚未完成,拒绝多次请求以免生成多个订单(可用BP.ForceFree()方法强制取消一次限制)<p>支付宝支付时6001为用户主动中断支付操作</p>微信支付返回-2时为用户主动中断操作,返回-3为未安装Bmob支付插件.apk</p>(如果多次出现异常请向Bmob工作人员反馈)</p>
</li>
<li>
<p>unknow()</p>
<p>因为网络等问题,不能确认是否支付成功,请稍后手动查询(小概率事件)</p>
</li>
</ul>
<p><strong>c.b.QListener</strong></p>
<ul>
<li>
<p>succeed(String status)</p>
<p><strong>查询成功(并不是说支付成功),返回的status有NOTPAY和SUCCESS两种可能</strong></p>
</li>
<li>
<p>fail(int code, String reason)</p>
<p>查询失败,有可能是网络问题,也有可能是订单号错误</p>
</li>
</ul>
<h2 id="_8">支付服务</h2>
<p>关于如何使用支付功能，请查看 <a href="./androidpay/index.html?menukey=fast_start&amp;key=start_android_pay" title="Android支付SDK">Android支付SDK</a> 或 <a href="./iospay/index.html?menukey=fast_start&amp;key=start_ios_pay" title="iOS支付SDK">iOS支付SDK</a>。RestAPI目前只提供了查询订单的功能。</p>
<h2 id="_9">查询订单</h2>
<pre><code>curl -X GET \
-H "X-Bmob-Application-Id: Your Application ID" \
-H "X-Bmob-REST-API-Key: Your REST API Key" \
https://api.bmob.cn/1/pay/Bmob系统生成的订单号
</code></pre>
<p>成功返回以下JSON, 失败时返回请看 <a href="./errorcode/index.html?menukey=otherdoc&amp;key=errorcode#支付功能相关错误码" title="支付功能相关错误码">支付功能相关错误码</a></p>
<pre><code>{
"name": "商品",
"body": "商品详情",
"create_time": "2015-03-24 11:14:58",
"out_trade_no": "9f392618f449a71c6fcfdee38d2b29e4",
"transaction_id": "2015061100001000330057820379"
"pay_type": "WECHATPAY",
"total_fee": 0.01,
"trade_state": "NOTPAY"
}
</code></pre>
<p>返回的信息简单描述如下：</p>
<ul>
<li>name           : 订单或商品名称 </li>
<li>body-商品详情</li>
<li>create_time    : 调起支付的时间</li>
<li>out_trade_no   : Bmob系统的订单号</li>
<li>transaction_id : 微信或支付宝的系统订单号</li>
<li>pay_type       : WECHATPAY（微信支付）或ALIPAY（支付宝支付）</li>
<li>total_fee      : 订单总金额</li>
<li>trade_state    : NOTPAY（未支付）或 SUCCESS（支付成功）</li>
</ul>
<h2 id="_10">支付回调</h2>
<p>如图，可以在支付-配置信息处填入通知url。</p>
<p><img alt="" src="http://i.imgur.com/40aAkKh.png" /></p>
<p>这样在支付成功后会向该url（SDK使用异步通知URL，PHP等调用网页支付的使用同步返回URL）发送post请求，结构如下：</p>
<pre><code>{
    &quot;trade_status&quot;:&quot;1&quot;,
    &quot;out_trade_no&quot;:&quot;809488d695ed42ec56b57546d2df94cc&quot;,
    &quot;trade_no&quot;:&quot;2016033021001004810225607152&quot;
}
</code></pre>

<p>trade_status：表示支付状态，目前只有支付成功才产生回调，值恒为1.
out_trade_no：Bmob返回的订单号
trade_no：支付宝或微信返回的订单号</p>
<h2 id="v31120170111">新版支付v3.1.1(20170111)的更新提示</h2>
<ul>
<li>ForceFree方法已经弃用，开发者需自己控制用户多次点击支付产生多个订单的问题</li>
<li>这一版本的SDK将会在支付的过程中呈现一个中间页面，这个页面负责引导用户的支付流程，带来的影响是：
    1)可以不用在pay的回调里调用BP.query进行查询，因为这个页面会确定用户的支付结果(试用demo.apk进行体验)
    2)可以不用在你自己的app内提供责任说明的页面</li>
<li>支付宝支付需要用户手机已经安装支付宝，微信支付仍然需要安装插件</li>
<li>市面上还流传小部分内存很吃紧的老款手机，在打开支付宝或者微信的时候可能导致你自己的app被系统杀掉，这种情况可以通过在后台填写&lt;支付结果的异步通知URL&gt;解决，结合云端代码来使用(详情见云端代码文档)</li>
<li>不用再针对小米手机获取订单时9015的问题添加额外的代码，微信支付插件不用网络权限，但在部分手机可能还是需要用户手动开启&lt;允许微信支付插件被其它app调起&gt;的权限</li>
<li>新版支付SDK对Unity支持的解决方法:<ul>
<li>新版支付SDK需要so文件，Unity3d开发者如果没有处理过类似情况，可以这样做：</li>
<li>将SDK中libs文件夹下，除了/armeabi、/armeabi-v7a、x86以外的文件夹删掉(jar文件需要保留)，然后把libs文件夹放在Plugins/Android/下。也就是最后会有 Plugins/Android/libs/armeabi/bmobwpay.so文件</li>
</ul>
</li>
</ul>
<h2 id="_11">其他</h2>
<ul>
<li>
<p>混淆规则如下: </p>
<pre><code>-libraryjars libs/BmobPay_v3.x.x_xxxxxx.jar
-keepclasseswithmembers class c.b.** { *; }
-keep interface c.b.PListener{ *; }
-keep interface c.b.QListener{ *; }
</code></pre>
</li>
<li>
<p>在<a href="http://www.bmob.cn/finance/info" title="Bmob财务管理平台">Bmob财务管理平台</a>订单管理处，金额从小数点后第三位开始不显示，比如支付了0.01元实收0.00，其实是0.0095</p>
</li>
<li>如果用户的手机有“应用锁”功能（即点击应用后跳出系统设定的解锁界面，如小米、360、腾讯管家都可能有该功能），则可能会导致支付中断（支付宝返回6001，微信返回-2），这是微信和支付宝SDK出于安全考虑设置的，请建议用户出现该问题时先关掉支付宝钱包或微信的应用锁</li>
<li>由于微信SDK的限制，无法判断微信是否已登陆用户，<strong>如果未登陆用户，监听器的fail方法可能不被调用</strong>，请开发者们提醒自己的用户确保微信已登陆</li>
<li>如果支付宝已经选定了支付用的账户（或银行卡），但是支付失败，用户的支付宝账号会保留该订单，有可能从支付宝官网、支付宝钱包APP再次发起支付，在开发过程中请注意这种事情的处理情况</li>
<li>如果请求支付的页面为横屏，微信支付页面可能出现抽风现象（卡顿甚至重启），是因为微信出现莫名Bug不停开启新支付页面导致内存爆满，解决方法：在AndroidManifest.xml中将com.bmob.pay.tool.PayActivity设为强制竖屏（上方有示例），并尽可能将自己调用的Activity也设置为竖屏</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright © 2017 <a href="http://www.bmob.cn/" target="_blank">Bmob</a>, Maintained by the Bmob Support.</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 0.16.3
Build Date UTC : 2017-05-22 07:34:40
-->
